<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1879px" preserveAspectRatio="none" style="width:2238px;height:1879px;" version="1.1" viewBox="0 0 2238 1879" width="2238px" zoomAndPan="magnify"><defs><filter height="300%" id="f1g4fkgeqyp6on" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="702" x="767" y="26.708">"Torflow measurements scaling with PID control (Per relay scaled bandwidth)."</text><path d="M1600.625,35.3711 L1600.625,43.9375 L1580.625,47.9375 L1600.625,51.9375 L1600.625,60.5039 A0,0 0 0 0 1600.625,60.5039 L1961.625,60.5039 A0,0 0 0 0 1961.625,60.5039 L1961.625,45.3711 L1951.625,35.3711 L1600.625,35.3711 A0,0 0 0 0 1600.625,35.3711 " fill="#FBFB77" filter="url(#f1g4fkgeqyp6on)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1951.625,35.3711 L1951.625,45.3711 L1961.625,45.3711 L1951.625,35.3711 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="1606.625" y="52.438">initialize measurements from previous Bandwidth File</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="165" x="1415.625" y="30.9531"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="145" x="1425.625" y="52.0918">prev_votes = VoteSet()</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="1441.125" y="84.9219"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="94" x="1451.125" y="106.0605">tot_net_bw = 0</text><path d="M1530.125,143.3086 L1530.125,151.875 L1510.125,155.875 L1530.125,159.875 L1530.125,168.4414 A0,0 0 0 0 1530.125,168.4414 L1702.125,168.4414 A0,0 0 0 0 1702.125,168.4414 L1702.125,153.3086 L1692.125,143.3086 L1530.125,143.3086 A0,0 0 0 0 1530.125,143.3086 " fill="#FBFB77" filter="url(#f1g4fkgeqyp6on)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1692.125,143.3086 L1692.125,153.3086 L1702.125,153.3086 L1692.125,143.3086 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="1536.125" y="160.3755">for every measurement</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="1486.125" y="138.8906"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="1500.125" y="160.0293"/><rect fill="#FFFFFF" filter="url(#f1g4fkgeqyp6on)" height="331.2656" style="stroke: #000000; stroke-width: 2.0;" width="799.5" x="1305.125" y="227.6611"/><path d="M1503.125,228.6611 L1503.125,236.958 L1493.125,246.958 L1305.125,246.958 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="188" x="1308.125" y="241.6563">Intialize ratios and pid_error</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="337" x="1329.625" y="263.958"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="317" x="1339.625" y="285.0967">n.fbw_ratio = n.filt_bw/true_filt_avg[n.node_class()]</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="366" x="1315.125" y="317.9268"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="346" x="1325.125" y="339.0654">n.sbw_ratio = n.strm_bw/true_strm_avg[n.node_class()]</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="161" x="1417.625" y="371.8955"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="141" x="1427.625" y="393.0342">n.use_bw = n.desc_bw</text><path d="M1700.625,415.8643 L1700.625,477.3955 L1680.625,481.3955 L1700.625,485.3955 L1700.625,546.9268 A0,0 0 0 0 1700.625,546.9268 L2094.625,546.9268 A0,0 0 0 0 2094.625,546.9268 L2094.625,425.8643 L2084.625,415.8643 L1700.625,415.8643 A0,0 0 0 0 1700.625,415.8643 " fill="#FBFB77" filter="url(#f1g4fkgeqyp6on)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2084.625,415.8643 L2084.625,425.8643 L2094.625,425.8643 L2084.625,415.8643 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1706.625" y="432.9312">if n.sbw_ratio &gt; n.fbw_ratio:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="1706.625" y="448.064">1.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="1722.625" y="448.064">assert cs_junk.use_best_ratio == True</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="1706.625" y="463.1968">n.pid_error = (n.strm_bw - true_strm_avg[n.node_class()])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1786.625" y="478.3296">/ true_strm_avg[n.node_class()]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1706.625" y="493.4624">else:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="1706.625" y="508.5952">n.pid_error = (n.filt_bw - true_filt_avg[n.node_class()])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="1786.625" y="523.728">/ true_filt_avg[n.node_class()]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="1706.625" y="538.8608">0 &lt;= n.pid_error &lt;= 500.0</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="365" x="1315.625" y="464.4111"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="345" x="1325.625" y="485.5498">n.pid_error = max(bwstrm_i / bwstrm, bwfilt_i / bwfilt) - 1</text><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="1405.125,578.9268,1591.125,578.9268,1603.125,590.9268,1591.125,602.9268,1405.125,602.9268,1393.125,590.9268,1405.125,578.9268" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="186" x="1405.125" y="594.7349">n.idhex in prev_votes.vote_map?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="1373.125" y="588.3325">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="1603.125" y="588.3325">no</text><path d="M987.25,612.9268 L987.25,629.0596 L967.25,633.0596 L987.25,637.0596 L987.25,653.1924 A0,0 0 0 0 987.25,653.1924 L1295.25,653.1924 A0,0 0 0 0 1295.25,653.1924 L1295.25,622.9268 L1285.25,612.9268 L987.25,612.9268 A0,0 0 0 0 987.25,612.9268 " fill="#FBFB77" filter="url(#f1g4fkgeqyp6on)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1285.25,612.9268 L1285.25,622.9268 L1295.25,622.9268 L1285.25,612.9268 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="993.25" y="629.9937">if n.measured_at &gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="993.25" y="645.1265">prev_votes.vote_map[n.idhex].measured_at;</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="943.25" y="616.0752"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="957.25" y="637.2139"/><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="892.75,688.1924,1017.75,688.1924,1029.75,700.1924,1017.75,712.1924,892.75,712.1924,880.75,700.1924,892.75,688.1924" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="125" x="892.75" y="704.0005">measurement newer?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="860.75" y="697.5981">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="1029.75" y="697.5981">no</text><path d="M533.5,722.1924 L533.5,738.3252 L513.5,742.3252 L533.5,746.3252 L533.5,762.458 A0,0 0 0 0 533.5,762.458 L875.5,762.458 A0,0 0 0 0 875.5,762.458 L875.5,732.1924 L865.5,722.1924 L533.5,722.1924 A0,0 0 0 0 533.5,722.1924 " fill="#FBFB77" filter="url(#f1g4fkgeqyp6on)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M865.5,722.1924 L865.5,732.1924 L875.5,732.1924 L865.5,722.1924 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="539.5" y="739.2593">if n.idhex in prev_consensus</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="555.5" y="754.3921">and ("Guard" in prev_consensus[n.idhex].flags=</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="489.5" y="725.3408"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="503.5" y="746.4795"/><path d="M533.5,847.4697 L533.5,878.7354 L513.5,882.7354 L533.5,886.7354 L533.5,918.001 A0,0 0 0 0 533.5,918.001 L980.5,918.001 A0,0 0 0 0 980.5,918.001 L980.5,857.4697 L970.5,847.4697 L533.5,847.4697 A0,0 0 0 0 533.5,847.4697 " fill="#FBFB77" filter="url(#f1g4fkgeqyp6on)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M970.5,847.4697 L970.5,857.4697 L980.5,857.4697 L970.5,847.4697 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="539.5" y="864.5366">if n.idhex not in prev_votes.vote_map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410" x="555.5" y="879.6694">or n.measured_at - prev_votes.vote_map[n.idhex].measured_at</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="571.5" y="894.8022">&gt; cs_junk.guard_sample_rate:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="571.5" y="909.9351"># cs_jung.guard_sample_rate = 2*7*24*60*60 # 2wks</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="489.5" y="865.751"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="503.5" y="886.8896"/><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="395.5,953.001,607.5,953.001,619.5,965.001,607.5,977.001,395.5,977.001,383.5,965.001,395.5,953.001" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="212" x="395.5" y="968.8091">not exit diff NOT bigger than 2 weeks</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="363.5" y="962.4067">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="619.5" y="962.4067">no</text><path d="M249,987.001 L249,1040.9658 L229,1044.9658 L249,1048.9658 L249,1102.9307 A0,0 0 0 0 249,1102.9307 L636,1102.9307 A0,0 0 0 0 636,1102.9307 L636,997.001 L626,987.001 L249,987.001 A0,0 0 0 0 249,987.001 " fill="#FBFB77" filter="url(#f1g4fkgeqyp6on)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M626,987.001 L626,997.001 L636,997.001 L626,987.001 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="255" y="1004.0679">\# Use new measurement but not feedback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="255" y="1019.2007">n.copy_vote(prev_vote.vote_map[n.idhex]));</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="255" y="1034.3335">n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="303" y="1049.4663">cs_junk.K_p,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="303" y="1064.5991">cs_junk.K_i,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="303" y="1079.7319">cs_junk.K_d,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="303" y="1094.8647">0.0, False)</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="205" y="1027.9814"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="219" y="1049.1201"/><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="145.7188" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="358" x="38" y="1137.9307"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="204" x="48" y="1159.0693">\# self.new_bw = vote.bw * 1000</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="159" x="48" y="1173.0381">self.pid_bw = vote.pid_bw</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="251" x="48" y="1187.0068">self.pid_error_sum = vote.pid_error_sum</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="189" x="48" y="1200.9756">self.pid_delta = vote.pid_delta</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="52" y="1214.9443"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="338" x="48" y="1228.9131">n.new_bw = self.use_bw + self.use_bw * self_pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="52" y="1242.8818"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="258" x="48" y="1256.8506">n.measured_at = prev_vote.measured_at</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="206" x="48" y="1270.8193">n.pid_error = prev_vote.pid_error</text><path d="M818,987.001 L818,1048.5322 L798,1052.5322 L818,1056.5322 L818,1118.0635 A0,0 0 0 0 818,1118.0635 L1205,1118.0635 A0,0 0 0 0 1205,1118.0635 L1205,997.001 L1195,987.001 L818,987.001 A0,0 0 0 0 818,987.001 " fill="#FBFB77" filter="url(#f1g4fkgeqyp6on)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1195,987.001 L1195,997.001 L1205,997.001 L1195,987.001 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="824" y="1004.0679">1.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="840" y="1004.0679">full feedback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="824" y="1019.2007">n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="888" y="1034.3335">cs_junk.K_p,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="888" y="1049.4663">cs_junk.K_i,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="888" y="1064.5991">cs_junk.K_d,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="888" y="1079.7319">cs_junk.K_i_decay)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="840" y="1094.8647">= n.get_pid_bw(prev_votes.vote_map[n.idhex],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="900" y="1109.9976">1.0, 0, 0, 0)</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="774" y="1035.5479"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="788" y="1056.6865"/><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="103.8125" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="260" x="656" y="1153.0635"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="228" x="666" y="1174.2021">self.prev_error = prev_vote.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="158" x="666" y="1188.1709">self.pid_bw = self.use_bw</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="182" x="682" y="1202.1396">+ self.use_bw * self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="203" x="682" y="1216.1084"># + self.desc_bw * self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="240" x="666" y="1230.0771">self.pid_error_sum = 0 + self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="146" x="666" y="1244.0459">n.new_bw = self.pid_bw</text><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="501.5,1289.6494,513.5,1301.6494,501.5,1313.6494,489.5,1301.6494,501.5,1289.6494" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="444,797.458,559,797.458,571,810.2627,559,823.0674,444,823.0674,432,810.2627,444,797.458" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="505.5" y="833.2778">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="111" x="444" y="807.6685">in prev_consensus,</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="53" x="444" y="820.4731">is guard?</text><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="501.5,1333.6494,513.5,1345.6494,501.5,1357.6494,489.5,1345.6494,501.5,1333.6494" style="stroke: #A80036; stroke-width: 1.5;"/><path d="M1441,722.1924 L1441,753.458 L1421,757.458 L1441,761.458 L1441,792.7236 A0,0 0 0 0 1441,792.7236 L1854,792.7236 A0,0 0 0 0 1854,792.7236 L1854,732.1924 L1844,722.1924 L1441,722.1924 A0,0 0 0 0 1441,722.1924 " fill="#FBFB77" filter="url(#f1g4fkgeqyp6on)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1844,722.1924 L1844,732.1924 L1854,732.1924 L1844,722.1924 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="1447" y="739.2593">\# Reset values. Don't vote/sample this measurement round.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="1447" y="754.3921">\# is in the previous bwfile, but haven't check the consensus</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="1447" y="769.5249">n.revert_to_vote(prev_votes.vote_map[n.idhex])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="1447" y="784.6577">\# which calls again self.copy_vote(vote)</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="1397" y="740.4736"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="1411" y="761.6123"/><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="117.7813" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="304" x="1257" y="827.7236"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="211" x="1267" y="848.8623">self.new_bw = prev_vote.bw*1000</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="192" x="1267" y="862.8311">self.pid_bw = prev_vote.pid_bw</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="284" x="1267" y="876.7998">self.pid_error_sum = prev_vote.pid_error_sum</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="222" x="1267" y="890.7686">self.pid_delta = prev_vote.pid_delta</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="1271" y="904.7373"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="187" x="1267" y="918.7061">self.pid_error = vote.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="239" x="1267" y="932.6748">self.measured_at = vote.measured_at</text><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="955.25,1363.6494,967.25,1375.6494,955.25,1387.6494,943.25,1375.6494,955.25,1363.6494" style="stroke: #A80036; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="61.9063" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="314" x="1884" y="612.9268"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="294" x="1894" y="634.0654">n.new_bw = n.use_bw + n.use_bw * n.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="186" x="1894" y="648.0342">n.pid_error_sum = n.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="132" x="1894" y="662.0029">n.pid_bw = n.new_bw</text><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="1498.125,1393.6494,1510.125,1405.6494,1498.125,1417.6494,1486.125,1405.6494,1498.125,1393.6494" style="stroke: #A80036; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="289" x="1353.625" y="1534.4541"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="269" x="1363.625" y="1555.5928">prev_consensus[n.idhex].measured = True</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="176" x="1410.125" y="1603.4229"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="156" x="1420.125" y="1624.5615">tot_net_bw += n.new_bw</text><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="1371.625,1486.0518,1624.625,1486.0518,1636.625,1498.0518,1624.625,1510.0518,1371.625,1510.0518,1359.625,1498.0518,1371.625,1486.0518" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="1502.125" y="1520.2622">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="253" x="1371.625" y="1501.8599">prev_consensus[n.idhex].bandwidth != None</text><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="1498.125,1657.3916,1510.125,1669.3916,1498.125,1681.3916,1486.125,1669.3916,1498.125,1657.3916" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="1422.125,1437.6494,1574.125,1437.6494,1586.125,1449.6494,1574.125,1461.6494,1422.125,1461.6494,1410.125,1449.6494,1422.125,1437.6494" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="1502.125" y="1471.8599">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="152" x="1422.125" y="1453.4575">n.idhex in prev_consensus</text><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="1498.125,1701.3916,1510.125,1713.3916,1498.125,1725.3916,1486.125,1713.3916,1498.125,1701.3916" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="1421.125,192.8594,1575.125,192.8594,1587.125,204.8594,1575.125,216.8594,1421.125,216.8594,1409.125,204.8594,1421.125,192.8594" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="154" x="1421.125" y="208.6675">for n in nodes.itervalues()?</text><rect fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="55" x="1470.625" y="1811.3916"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="35" x="1480.625" y="1832.5303">cap...</text><polygon fill="#FEFECE" filter="url(#f1g4fkgeqyp6on)" points="1421.125,1767.3916,1575.125,1767.3916,1587.125,1779.3916,1575.125,1791.3916,1421.125,1791.3916,1409.125,1779.3916,1421.125,1767.3916" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="154" x="1421.125" y="1783.1997">for n in nodes.itervalues()?</text><ellipse cx="1399.125" cy="1821.3916" fill="none" filter="url(#f1g4fkgeqyp6on)" rx="10" ry="10" style="stroke: #000000; stroke-width: 1.0;"/><ellipse cx="1399.625" cy="1821.8916" fill="#000000" filter="url(#f1g4fkgeqyp6on)" rx="6" ry="6" style="stroke: none; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="64.9219" y2="84.9219"/><polygon fill="#A80036" points="1494.125,74.9219,1498.125,84.9219,1502.125,74.9219,1498.125,78.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="118.8906" y2="138.8906"/><polygon fill="#A80036" points="1494.125,128.8906,1498.125,138.8906,1502.125,128.8906,1498.125,132.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="297.9268" y2="317.9268"/><polygon fill="#A80036" points="1494.125,307.9268,1498.125,317.9268,1502.125,307.9268,1498.125,311.9268" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="351.8955" y2="371.8955"/><polygon fill="#A80036" points="1494.125,361.8955,1498.125,371.8955,1502.125,361.8955,1498.125,365.8955" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="405.8643" y2="464.4111"/><polygon fill="#A80036" points="1494.125,454.4111,1498.125,464.4111,1502.125,454.4111,1498.125,458.4111" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="217" x2="217" y1="1061.9502" y2="1137.9307"/><polygon fill="#A80036" points="213,1127.9307,217,1137.9307,221,1127.9307,217,1131.9307" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="786" x2="786" y1="1069.5166" y2="1153.0635"/><polygon fill="#A80036" points="782,1143.0635,786,1153.0635,790,1143.0635,786,1147.0635" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="383.5" x2="217" y1="965.001" y2="965.001"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="217" x2="217" y1="965.001" y2="1027.9814"/><polygon fill="#A80036" points="213,1017.9814,217,1027.9814,221,1017.9814,217,1021.9814" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="619.5" x2="786" y1="965.001" y2="965.001"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="786" x2="786" y1="965.001" y2="1035.5479"/><polygon fill="#A80036" points="782,1025.5479,786,1035.5479,790,1025.5479,786,1029.5479" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="217" x2="217" y1="1283.6494" y2="1301.6494"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="217" x2="489.5" y1="1301.6494" y2="1301.6494"/><polygon fill="#A80036" points="479.5,1297.6494,489.5,1301.6494,479.5,1305.6494,483.5,1301.6494" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="786" x2="786" y1="1256.876" y2="1301.6494"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="786" x2="513.5" y1="1301.6494" y2="1301.6494"/><polygon fill="#A80036" points="523.5,1297.6494,513.5,1301.6494,523.5,1305.6494,519.5,1301.6494" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="501.5" x2="501.5" y1="899.7197" y2="953.001"/><polygon fill="#A80036" points="497.5,943.001,501.5,953.001,505.5,943.001,501.5,947.001" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="501.5" x2="501.5" y1="823.0674" y2="865.751"/><polygon fill="#A80036" points="497.5,855.751,501.5,865.751,505.5,855.751,501.5,859.751" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="571" x2="1225" y1="810.2627" y2="810.2627"/><polygon fill="#A80036" points="1221,1070.1572,1225,1080.1572,1229,1070.1572,1225,1074.1572" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1225" x2="1225" y1="810.2627" y2="1345.6494"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1225" x2="513.5" y1="1345.6494" y2="1345.6494"/><polygon fill="#A80036" points="523.5,1341.6494,513.5,1345.6494,523.5,1349.6494,519.5,1345.6494" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="501.5" x2="501.5" y1="1313.6494" y2="1333.6494"/><polygon fill="#A80036" points="497.5,1323.6494,501.5,1333.6494,505.5,1323.6494,501.5,1327.6494" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="501.5" x2="501.5" y1="759.3096" y2="797.458"/><polygon fill="#A80036" points="497.5,787.458,501.5,797.458,505.5,787.458,501.5,791.458" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1409" x2="1409" y1="774.4424" y2="827.7236"/><polygon fill="#A80036" points="1405,817.7236,1409,827.7236,1413,817.7236,1409,821.7236" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="880.75" x2="501.5" y1="700.1924" y2="700.1924"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="501.5" x2="501.5" y1="700.1924" y2="725.3408"/><polygon fill="#A80036" points="497.5,715.3408,501.5,725.3408,505.5,715.3408,501.5,719.3408" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1029.75" x2="1409" y1="700.1924" y2="700.1924"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1409" x2="1409" y1="700.1924" y2="740.4736"/><polygon fill="#A80036" points="1405,730.4736,1409,740.4736,1413,730.4736,1409,734.4736" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="501.5" x2="501.5" y1="1357.6494" y2="1375.6494"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="501.5" x2="943.25" y1="1375.6494" y2="1375.6494"/><polygon fill="#A80036" points="933.25,1371.6494,943.25,1375.6494,933.25,1379.6494,937.25,1375.6494" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1409" x2="1409" y1="945.5049" y2="1375.6494"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1409" x2="967.25" y1="1375.6494" y2="1375.6494"/><polygon fill="#A80036" points="977.25,1371.6494,967.25,1375.6494,977.25,1379.6494,973.25,1375.6494" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="955.25" x2="955.25" y1="650.0439" y2="688.1924"/><polygon fill="#A80036" points="951.25,678.1924,955.25,688.1924,959.25,678.1924,955.25,682.1924" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1393.125" x2="955.25" y1="590.9268" y2="590.9268"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="955.25" x2="955.25" y1="590.9268" y2="616.0752"/><polygon fill="#A80036" points="951.25,606.0752,955.25,616.0752,959.25,606.0752,955.25,610.0752" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1603.125" x2="2041" y1="590.9268" y2="590.9268"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2041" x2="2041" y1="590.9268" y2="612.9268"/><polygon fill="#A80036" points="2037,602.9268,2041,612.9268,2045,602.9268,2041,606.9268" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="955.25" x2="955.25" y1="1387.6494" y2="1405.6494"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="955.25" x2="1486.125" y1="1405.6494" y2="1405.6494"/><polygon fill="#A80036" points="1476.125,1401.6494,1486.125,1405.6494,1476.125,1409.6494,1480.125,1405.6494" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2041" x2="2041" y1="674.833" y2="1405.6494"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2041" x2="1510.125" y1="1405.6494" y2="1405.6494"/><polygon fill="#A80036" points="1520.125,1401.6494,1510.125,1405.6494,1520.125,1409.6494,1516.125,1405.6494" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="498.3799" y2="578.9268"/><polygon fill="#A80036" points="1494.125,568.9268,1498.125,578.9268,1502.125,568.9268,1498.125,572.9268" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="1568.4229" y2="1603.4229"/><polygon fill="#A80036" points="1494.125,1593.4229,1498.125,1603.4229,1502.125,1593.4229,1498.125,1597.4229" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="1510.0518" y2="1534.4541"/><polygon fill="#A80036" points="1494.125,1524.4541,1498.125,1534.4541,1502.125,1524.4541,1498.125,1528.4541" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1636.625" x2="1652.625" y1="1498.0518" y2="1498.0518"/><polygon fill="#A80036" points="1648.625,1575.9229,1652.625,1585.9229,1656.625,1575.9229,1652.625,1579.9229" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1652.625" x2="1652.625" y1="1498.0518" y2="1669.3916"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1652.625" x2="1510.125" y1="1669.3916" y2="1669.3916"/><polygon fill="#A80036" points="1520.125,1665.3916,1510.125,1669.3916,1520.125,1673.3916,1516.125,1669.3916" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="1637.3916" y2="1657.3916"/><polygon fill="#A80036" points="1494.125,1647.3916,1498.125,1657.3916,1502.125,1647.3916,1498.125,1651.3916" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="1461.6494" y2="1486.0518"/><polygon fill="#A80036" points="1494.125,1476.0518,1498.125,1486.0518,1502.125,1476.0518,1498.125,1480.0518" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1586.125" x2="1674.625" y1="1449.6494" y2="1449.6494"/><polygon fill="#A80036" points="1670.625,1575.9229,1674.625,1585.9229,1678.625,1575.9229,1674.625,1579.9229" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1674.625" x2="1674.625" y1="1449.6494" y2="1713.3916"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1674.625" x2="1510.125" y1="1713.3916" y2="1713.3916"/><polygon fill="#A80036" points="1520.125,1709.3916,1510.125,1713.3916,1520.125,1717.3916,1516.125,1713.3916" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="1681.3916" y2="1701.3916"/><polygon fill="#A80036" points="1494.125,1691.3916,1498.125,1701.3916,1502.125,1691.3916,1498.125,1695.3916" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="1417.6494" y2="1437.6494"/><polygon fill="#A80036" points="1494.125,1427.6494,1498.125,1437.6494,1502.125,1427.6494,1498.125,1431.6494" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="216.8594" y2="263.958"/><polygon fill="#A80036" points="1494.125,253.958,1498.125,263.958,1502.125,253.958,1498.125,257.958" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="1725.3916" y2="1735.3916"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="2212" y1="1735.3916" y2="1735.3916"/><polygon fill="#A80036" points="2208,949.6299,2212,939.6299,2216,949.6299,2212,945.6299" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2212" x2="2212" y1="204.8594" y2="1735.3916"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2212" x2="1587.125" y1="204.8594" y2="204.8594"/><polygon fill="#A80036" points="1597.125,200.8594,1587.125,204.8594,1597.125,208.8594,1593.125,204.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1409.125" x2="24" y1="204.8594" y2="204.8594"/><polygon fill="#A80036" points="20,935.6299,24,945.6299,28,935.6299,24,939.6299" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="24" x2="24" y1="204.8594" y2="1747.3916"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="24" x2="1498.125" y1="1747.3916" y2="1747.3916"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="1747.3916" y2="1767.3916"/><polygon fill="#A80036" points="1494.125,1757.3916,1498.125,1767.3916,1502.125,1757.3916,1498.125,1761.3916" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="172.8594" y2="192.8594"/><polygon fill="#A80036" points="1494.125,182.8594,1498.125,192.8594,1502.125,182.8594,1498.125,186.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="1791.3916" y2="1811.3916"/><polygon fill="#A80036" points="1494.125,1801.3916,1498.125,1811.3916,1502.125,1801.3916,1498.125,1805.3916" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1498.125" y1="1845.3604" y2="1855.3604"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1498.125" x2="1599.125" y1="1855.3604" y2="1855.3604"/><polygon fill="#A80036" points="1595.125,1826.376,1599.125,1816.376,1603.125,1826.376,1599.125,1822.376" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1599.125" x2="1599.125" y1="1779.3916" y2="1855.3604"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1599.125" x2="1587.125" y1="1779.3916" y2="1779.3916"/><polygon fill="#A80036" points="1597.125,1775.3916,1587.125,1779.3916,1597.125,1783.3916,1593.125,1779.3916" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1409.125" x2="1399.125" y1="1779.3916" y2="1779.3916"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1399.125" x2="1399.125" y1="1779.3916" y2="1811.3916"/><polygon fill="#A80036" points="1395.125,1801.3916,1399.125,1811.3916,1403.125,1801.3916,1399.125,1805.3916" style="stroke: #A80036; stroke-width: 1.0;"/><!--
@startuml
title "Torflow measurements scaling with PID control (Per relay scaled bandwidth)."

:prev_votes = VoteSet();
note right
initialize measurements from previous Bandwidth File
end note
:tot_net_bw = 0;
:;
note right
    for every measurement
end note
while (for n in nodes.itervalues()?)
    partition "Intialize ratios and pid_error" {
        :n.fbw_ratio = n.filt_bw/true_filt_avg[n.node_class()];
        :n.sbw_ratio = n.strm_bw/true_strm_avg[n.node_class()];
        :n.use_bw = n.desc_bw;
        :n.pid_error = max(bwstrm_i / bwstrm, bwfilt_i / bwfilt) - 1;
        note right
            if n.sbw_ratio > n.fbw_ratio:
            #assert cs_junk.use_best_ratio == True
            n.pid_error = (n.strm_bw - true_strm_avg[n.node_class()])
                                / true_strm_avg[n.node_class()]
            else:
            n.pid_error = (n.filt_bw - true_filt_avg[n.node_class()])
                                / true_filt_avg[n.node_class()]
            0 <= n.pid_error <= 500.0
        end note
    }
    if (n.idhex in prev_votes.vote_map?) then (yes)
        :;
        note right
        if n.measured_at >
        prev_votes.vote_map[n.idhex].measured_at;
        end note
        if (measurement newer?) then (yes)
            :;
            note right
            if n.idhex in prev_consensus
                and ("Guard" in prev_consensus[n.idhex].flags=
            end note
            if (in prev_consensus, \nis guard?) then (yes)
                :;
                note right
                if n.idhex not in prev_votes.vote_map
                    or n.measured_at - prev_votes.vote_map[n.idhex].measured_at
                        > cs_junk.guard_sample_rate:
                        # cs_jung.guard_sample_rate = 2*7*24*60*60 # 2wks
                end note
                if (not exit diff NOT bigger than 2 weeks) then (yes)
                    :;
                    note right
                    \# Use new measurement but not feedback
                    n.copy_vote(prev_vote.vote_map[n.idhex]));
                    n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],
                                cs_junk.K_p,
                                cs_junk.K_i,
                                cs_junk.K_d,
                                0.0, False)
                    end note
                    :\# self.new_bw = vote.bw * 1000
                    self.pid_bw = vote.pid_bw
                    self.pid_error_sum = vote.pid_error_sum
                    self.pid_delta = vote.pid_delta

                    n.new_bw = self.use_bw + self.use_bw * self_pid_error

                    n.measured_at = prev_vote.measured_at
                    n.pid_error = prev_vote.pid_error;
                else (no)
                    :;
                    note right
                    # full feedback
                    n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],
                                    cs_junk.K_p,
                                    cs_junk.K_i,
                                    cs_junk.K_d,
                                    cs_junk.K_i_decay)
                        = n.get_pid_bw(prev_votes.vote_map[n.idhex],
                                       1.0, 0, 0, 0)
                    end note
                    :self.prev_error = prev_vote.pid_error
                    self.pid_bw = self.use_bw
                        + self.use_bw * self.pid_error
                        # + self.desc_bw * self.pid_error
                    self.pid_error_sum = 0 + self.pid_error
                    n.new_bw = self.pid_bw;
                endif
            endif
        else (no)
            :;
            note right
            \# Reset values. Don't vote/sample this measurement round.
            \# is in the previous bwfile, but haven't check the consensus
            n.revert_to_vote(prev_votes.vote_map[n.idhex])
            \# which calls again self.copy_vote(vote)
            end note
            :self.new_bw = prev_vote.bw*1000
            self.pid_bw = prev_vote.pid_bw
            self.pid_error_sum = prev_vote.pid_error_sum
            self.pid_delta = prev_vote.pid_delta

            self.pid_error = vote.pid_error
            self.measured_at = vote.measured_at;

        endif
    else (no)
        :n.new_bw = n.use_bw + n.use_bw * n.pid_error
        n.pid_error_sum = n.pid_error
        n.pid_bw = n.new_bw;
    endif

    if (n.idhex in prev_consensus) then (yes)
        if (prev_consensus[n.idhex].bandwidth != None) then (yes)
            :prev_consensus[n.idhex].measured = True;
            :tot_net_bw += n.new_bw;
        endif
    endif
endwhile
while (for n in nodes.itervalues()?)
    :cap...;
endwhile
stop

@enduml

PlantUML version 1.2018.13(Mon Nov 26 17:11:51 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.9.1+1-post-Debian-1deb10u2
Operating System: Linux
OS Version: 4.19.0-13-amd64
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>