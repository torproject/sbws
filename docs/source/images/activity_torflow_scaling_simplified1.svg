<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="976px" preserveAspectRatio="none" style="width:726px;height:976px;" version="1.1" viewBox="0 0 726 976" width="726px" zoomAndPan="magnify"><defs><filter height="300%" id="f1pyhrde7xrk7i" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="702" x="12" y="26.708">"Torflow measurements scaling with PID control (Per relay scaled bandwidth)."</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="165" x="266.75" y="30.9531"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="145" x="276.75" y="52.0918">prev_votes = VoteSet()</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="292.25" y="84.9219"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="94" x="302.25" y="106.0605">tot_net_bw = 0</text><path d="M381.25,143.3086 L381.25,151.875 L361.25,155.875 L381.25,159.875 L381.25,168.4414 A0,0 0 0 0 381.25,168.4414 L553.25,168.4414 A0,0 0 0 0 553.25,168.4414 L553.25,153.3086 L543.25,143.3086 L381.25,143.3086 A0,0 0 0 0 381.25,143.3086 " fill="#FBFB77" filter="url(#f1pyhrde7xrk7i)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M543.25,143.3086 L543.25,153.3086 L553.25,153.3086 L543.25,143.3086 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="387.25" y="160.3755">for every measurement</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="337.25" y="138.8906"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="351.25" y="160.0293"/><rect fill="#FFFFFF" filter="url(#f1pyhrde7xrk7i)" height="244.1719" style="stroke: #000000; stroke-width: 2.0;" width="386" x="156.25" y="227.6611"/><path d="M354.25,228.6611 L354.25,236.958 L344.25,246.958 L156.25,246.958 " fill="none" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="188" x="159.25" y="241.6563">Intialize ratios and pid_error</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="337" x="180.75" y="263.958"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="317" x="190.75" y="285.0967">n.fbw_ratio = n.filt_bw/true_filt_avg[n.node_class()]</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="366" x="166.25" y="317.9268"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="346" x="176.25" y="339.0654">n.sbw_ratio = n.strm_bw/true_strm_avg[n.node_class()]</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="161" x="268.75" y="371.8955"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="141" x="278.75" y="393.0342">n.use_bw = n.desc_bw</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="308" x="195.25" y="425.8643"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="288" x="205.25" y="447.0029">n.pid_error = max(n.fbw_ratio, n.sbw_ratio) - 1</text><polygon fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" points="257.25,491.833,441.25,491.833,453.25,504.6377,441.25,517.4424,257.25,517.4424,245.25,504.6377,257.25,491.833" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="180" x="257.25" y="502.0435">n.idhex in prev_votes.vote_map</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="172" x="257.25" y="514.8481">and not newer measurement?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="225.25" y="502.0435">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="453.25" y="502.0435">no</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="47.9375" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="259" x="66.5" y="527.4424"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="211" x="76.5" y="548.5811">self.new_bw = prev_vote.bw*1000</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="239" x="76.5" y="562.5498">self.measured_at = vote.measured_at</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="314" x="345.5" y="527.4424"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="294" x="355.5" y="548.5811">n.new_bw = n.use_bw + n.use_bw * n.pid_error</text><polygon fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" points="349.25,581.3799,361.25,593.3799,349.25,605.3799,337.25,593.3799,349.25,581.3799" style="stroke: #A80036; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="289" x="204.75" y="675.3916"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="269" x="214.75" y="696.5303">prev_consensus[n.idhex].measured = True</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="176" x="261.25" y="744.3604"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="156" x="271.25" y="765.499">tot_net_bw += n.new_bw</text><polygon fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" points="210.25,625.3799,488.25,625.3799,500.25,638.1846,488.25,650.9893,210.25,650.9893,198.25,638.1846,210.25,625.3799" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="353.25" y="661.1997">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="152" x="210.25" y="635.5903">n.idhex in prev_consensus</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="278" x="210.25" y="648.395">and prev_consensus[n.idhex].bandwidth != None</text><polygon fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" points="349.25,798.3291,361.25,810.3291,349.25,822.3291,337.25,810.3291,349.25,798.3291" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" points="272.25,192.8594,426.25,192.8594,438.25,204.8594,426.25,216.8594,272.25,216.8594,260.25,204.8594,272.25,192.8594" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="154" x="272.25" y="208.6675">for n in nodes.itervalues()?</text><rect fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="55" x="321.75" y="908.3291"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="35" x="331.75" y="929.4678">cap...</text><polygon fill="#FEFECE" filter="url(#f1pyhrde7xrk7i)" points="272.25,864.3291,426.25,864.3291,438.25,876.3291,426.25,888.3291,272.25,888.3291,260.25,876.3291,272.25,864.3291" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="154" x="272.25" y="880.1372">for n in nodes.itervalues()?</text><ellipse cx="250.25" cy="918.3291" fill="none" filter="url(#f1pyhrde7xrk7i)" rx="10" ry="10" style="stroke: #000000; stroke-width: 1.0;"/><ellipse cx="250.75" cy="918.8291" fill="#000000" filter="url(#f1pyhrde7xrk7i)" rx="6" ry="6" style="stroke: none; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="64.9219" y2="84.9219"/><polygon fill="#A80036" points="345.25,74.9219,349.25,84.9219,353.25,74.9219,349.25,78.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="118.8906" y2="138.8906"/><polygon fill="#A80036" points="345.25,128.8906,349.25,138.8906,353.25,128.8906,349.25,132.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="297.9268" y2="317.9268"/><polygon fill="#A80036" points="345.25,307.9268,349.25,317.9268,353.25,307.9268,349.25,311.9268" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="351.8955" y2="371.8955"/><polygon fill="#A80036" points="345.25,361.8955,349.25,371.8955,353.25,361.8955,349.25,365.8955" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="405.8643" y2="425.8643"/><polygon fill="#A80036" points="345.25,415.8643,349.25,425.8643,353.25,415.8643,349.25,419.8643" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="245.25" x2="196" y1="504.6377" y2="504.6377"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="196" x2="196" y1="504.6377" y2="527.4424"/><polygon fill="#A80036" points="192,517.4424,196,527.4424,200,517.4424,196,521.4424" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="453.25" x2="502.5" y1="504.6377" y2="504.6377"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="502.5" x2="502.5" y1="504.6377" y2="527.4424"/><polygon fill="#A80036" points="498.5,517.4424,502.5,527.4424,506.5,517.4424,502.5,521.4424" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="196" x2="196" y1="575.3799" y2="593.3799"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="196" x2="337.25" y1="593.3799" y2="593.3799"/><polygon fill="#A80036" points="327.25,589.3799,337.25,593.3799,327.25,597.3799,331.25,593.3799" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="502.5" x2="502.5" y1="561.4111" y2="593.3799"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="502.5" x2="361.25" y1="593.3799" y2="593.3799"/><polygon fill="#A80036" points="371.25,589.3799,361.25,593.3799,371.25,597.3799,367.25,593.3799" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="459.833" y2="491.833"/><polygon fill="#A80036" points="345.25,481.833,349.25,491.833,353.25,481.833,349.25,485.833" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="709.3604" y2="744.3604"/><polygon fill="#A80036" points="345.25,734.3604,349.25,744.3604,353.25,734.3604,349.25,738.3604" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="650.9893" y2="675.3916"/><polygon fill="#A80036" points="345.25,665.3916,349.25,675.3916,353.25,665.3916,349.25,669.3916" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="500.25" x2="512.25" y1="638.1846" y2="638.1846"/><polygon fill="#A80036" points="508.25,716.458,512.25,726.458,516.25,716.458,512.25,720.458" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="512.25" x2="512.25" y1="638.1846" y2="810.3291"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="512.25" x2="361.25" y1="810.3291" y2="810.3291"/><polygon fill="#A80036" points="371.25,806.3291,361.25,810.3291,371.25,814.3291,367.25,810.3291" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="778.3291" y2="798.3291"/><polygon fill="#A80036" points="345.25,788.3291,349.25,798.3291,353.25,788.3291,349.25,792.3291" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="605.3799" y2="625.3799"/><polygon fill="#A80036" points="345.25,615.3799,349.25,625.3799,353.25,615.3799,349.25,619.3799" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="216.8594" y2="263.958"/><polygon fill="#A80036" points="345.25,253.958,349.25,263.958,353.25,253.958,349.25,257.958" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="822.3291" y2="832.3291"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="673.5" y1="832.3291" y2="832.3291"/><polygon fill="#A80036" points="669.5,498.6963,673.5,488.6963,677.5,498.6963,673.5,494.6963" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="673.5" x2="673.5" y1="204.8594" y2="832.3291"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="673.5" x2="438.25" y1="204.8594" y2="204.8594"/><polygon fill="#A80036" points="448.25,200.8594,438.25,204.8594,448.25,208.8594,444.25,204.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="260.25" x2="52.5" y1="204.8594" y2="204.8594"/><polygon fill="#A80036" points="48.5,484.6963,52.5,494.6963,56.5,484.6963,52.5,488.6963" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="52.5" x2="52.5" y1="204.8594" y2="844.3291"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="52.5" x2="349.25" y1="844.3291" y2="844.3291"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="844.3291" y2="864.3291"/><polygon fill="#A80036" points="345.25,854.3291,349.25,864.3291,353.25,854.3291,349.25,858.3291" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="172.8594" y2="192.8594"/><polygon fill="#A80036" points="345.25,182.8594,349.25,192.8594,353.25,182.8594,349.25,186.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="888.3291" y2="908.3291"/><polygon fill="#A80036" points="345.25,898.3291,349.25,908.3291,353.25,898.3291,349.25,902.3291" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="349.25" y1="942.2979" y2="952.2979"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="349.25" x2="450.25" y1="952.2979" y2="952.2979"/><polygon fill="#A80036" points="446.25,923.3135,450.25,913.3135,454.25,923.3135,450.25,919.3135" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="450.25" x2="450.25" y1="876.3291" y2="952.2979"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="450.25" x2="438.25" y1="876.3291" y2="876.3291"/><polygon fill="#A80036" points="448.25,872.3291,438.25,876.3291,448.25,880.3291,444.25,876.3291" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="260.25" x2="250.25" y1="876.3291" y2="876.3291"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="250.25" x2="250.25" y1="876.3291" y2="908.3291"/><polygon fill="#A80036" points="246.25,898.3291,250.25,908.3291,254.25,898.3291,250.25,902.3291" style="stroke: #A80036; stroke-width: 1.0;"/><!--
@startuml
title "Torflow measurements scaling with PID control (Per relay scaled bandwidth)."

:prev_votes = VoteSet();
:tot_net_bw = 0;
:;
note right
    for every measurement
end note
while (for n in nodes.itervalues()?)
    partition "Intialize ratios and pid_error" {
        :n.fbw_ratio = n.filt_bw/true_filt_avg[n.node_class()];
        :n.sbw_ratio = n.strm_bw/true_strm_avg[n.node_class()];
        :n.use_bw = n.desc_bw;
        :n.pid_error = max(n.fbw_ratio, n.sbw_ratio) - 1;
    }
    if (n.idhex in prev_votes.vote_map \nand not newer measurement?) then (yes)
        :self.new_bw = prev_vote.bw*1000
        self.measured_at = vote.measured_at;
    else (no)
        :n.new_bw = n.use_bw + n.use_bw * n.pid_error;
    endif

    if (n.idhex in prev_consensus \nand prev_consensus[n.idhex].bandwidth != None) then (yes)
            :prev_consensus[n.idhex].measured = True;
            :tot_net_bw += n.new_bw;
    endif
endwhile
while (for n in nodes.itervalues()?)
    :cap...;
endwhile
stop

@enduml

PlantUML version 1.2018.13(Mon Nov 26 17:11:51 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.9.1+1-post-Debian-1deb10u2
Operating System: Linux
OS Version: 4.19.0-13-amd64
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>